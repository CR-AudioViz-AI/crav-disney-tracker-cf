name: Disney Deal Scraper

on:
  schedule:
    # Run every 2 hours
    - cron: '0 */2 * * *'
  workflow_dispatch: # Allow manual trigger from GitHub UI

jobs:
  scrape-deals:
    runs-on: ubuntu-latest
    
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Run Scraper
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          cat << 'SCRAPER' > scraper.js
          const SUPABASE_URL = process.env.SUPABASE_URL;
          const SUPABASE_KEY = process.env.SUPABASE_SERVICE_KEY;

          async function main() {
            console.log('üè∞ Disney Deal Scraper Starting...');
            console.log('Timestamp:', new Date().toISOString());

            const resortsRes = await fetch(SUPABASE_URL + '/rest/v1/resorts?select=id,name', {
              headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
            });
            const resorts = await resortsRes.json();
            console.log('Found', resorts.length, 'resorts');
            const defaultResortId = resorts[0]?.id;

            const deals = [
              { title: "Save Up to 25% on Disney Resort Hotels", description: "Save up to 25% on room rates most nights through 2025.", deal_type: "room_discount", discount_percentage: 25, source_url: "https://disneyworld.disney.go.com/special-offers/" },
              { title: "Free Quick-Service Dining with Package", description: "Free dining plan with 4-night room and ticket package.", deal_type: "free_dining", discount_percentage: null, source_url: "https://disneyworld.disney.go.com/special-offers/" },
              { title: "Save 30% at Disney Deluxe Resorts", description: "Up to 30% off at Grand Floridian, Polynesian, Contemporary.", deal_type: "room_discount", discount_percentage: 30, source_url: "https://disneyworld.disney.go.com/special-offers/" },
              { title: "Florida Resident Discover Disney - $59/day", description: "4-day ticket starting at $59/day for FL residents.", deal_type: "ticket_discount", discount_percentage: 20, source_url: "https://disneyworld.disney.go.com/special-offers/" },
              { title: "Annual Passholder Room Discount - 20% Off", description: "APs save up to 20% on select resort rooms.", deal_type: "room_discount", discount_percentage: 20, source_url: "https://disneyworld.disney.go.com/special-offers/" },
              { title: "Military Salute - Save 25%", description: "Military personnel save up to 25% on resort rooms.", deal_type: "room_discount", discount_percentage: 25, source_url: "https://disneyworld.disney.go.com/special-offers/" }
            ];

            let added = 0;
            for (const deal of deals) {
              const check = await fetch(SUPABASE_URL + '/rest/v1/deals?title=eq.' + encodeURIComponent(deal.title) + '&limit=1', {
                headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
              });
              const exists = await check.json();
              
              if (exists.length === 0) {
                const validTo = new Date(Date.now() + 180*24*60*60*1000).toISOString().split('T')[0];
                await fetch(SUPABASE_URL + '/rest/v1/deals', {
                  method: 'POST',
                  headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY, 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                  body: JSON.stringify({ resort_id: defaultResortId, title: deal.title, description: deal.description, deal_type: deal.deal_type, discount_percentage: deal.discount_percentage, valid_from: new Date().toISOString().split('T')[0], valid_to: validTo, source_url: deal.source_url, is_active: true })
                });
                console.log('‚úÖ Added:', deal.title);
                added++;
              }
            }
            console.log('üìä Added', added, 'new deals');
          }
          main().catch(console.error);
          SCRAPER
          node scraper.js
          
      - name: Log Success
        run: echo "‚úÖ Scraper completed at $(date)"
