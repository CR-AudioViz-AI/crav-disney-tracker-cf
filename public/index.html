<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disney Deal Tracker + Live Availability</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè∞</text></svg>">
    <style>
        .clickable { cursor: pointer; transition: all 0.2s ease; }
        .clickable:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        .deal-card:hover { background: linear-gradient(135deg, #eff6ff 0%, #f0fdf4 100%); }
        .stat-card:hover { transform: scale(1.03); }
        .calendar-day.has-deals { background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); cursor: pointer; font-weight: 600; }
        .calendar-day.has-deals:hover { transform: scale(1.15); box-shadow: 0 4px 12px rgba(34,197,94,0.4); }
        .modal-overlay { opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content { transform: scale(0.9) translateY(20px); transition: all 0.3s ease; }
        .modal-overlay.active .modal-content { transform: scale(1) translateY(0); }
        .filter-btn.active { background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%); color: white; border-color: transparent; }
        .tab-btn.active { background: white; color: #3b82f6; border-bottom: 3px solid #3b82f6; }
        .hotel-tab.active { border-color: #3b82f6 !important; color: #3b82f6 !important; }
        .availability-good { background: #dcfce7; color: #166534; }
        .availability-limited { background: #fef9c3; color: #854d0e; }
        .availability-none { background: #fee2e2; color: #991b1b; }
        .resort-item:hover { background: #f3f4f6; }
        .price-tag { background: linear-gradient(135deg, #059669 0%, #10b981 100%); }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .animate-spin { animation: spin 1s linear infinite; }
        .pulse { animation: pulse 2s infinite; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 via-purple-600 to-pink-500 text-white shadow-xl">
        <div class="max-w-7xl mx-auto px-4 py-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h1 class="text-3xl font-bold flex items-center gap-3">üè∞ Disney Deal Tracker</h1>
                    <p class="text-blue-100 mt-1">Real-time deals + Live Hotel Availability</p>
                </div>
                <div class="flex flex-wrap gap-2">
                    <button onclick="refreshDeals()" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg font-medium transition flex items-center gap-2">
                        <span id="refresh-icon">üîÑ</span> Refresh
                    </button>
                    <button onclick="showExportModal()" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg font-medium transition">üìä Export</button>
                    <button onclick="showTab('availability')" class="bg-yellow-400 hover:bg-yellow-300 text-yellow-900 px-4 py-2 rounded-lg font-bold transition flex items-center gap-2">
                        üîç Check Availability
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Tab Navigation -->
    <div class="bg-white shadow-sm sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex gap-1">
                <button onclick="showTab('deals')" class="tab-btn active px-6 py-4 font-medium text-gray-600 transition" data-tab="deals">üî• Deals</button>
                <button onclick="showTab('availability')" class="tab-btn px-6 py-4 font-medium text-gray-600 transition" data-tab="availability">üè® Availability</button>
                <button onclick="showTab('calendar')" class="tab-btn px-6 py-4 font-medium text-gray-600 transition" data-tab="calendar">üìÖ Calendar</button>
                <button onclick="showTab('sources')" class="tab-btn px-6 py-4 font-medium text-gray-600 transition" data-tab="sources">üì° Sources</button>
            </div>
        </div>
    </div>

    <main class="max-w-7xl mx-auto px-4 py-8">
        <!-- Stats Bar -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div onclick="filterDeals('all')" class="stat-card clickable bg-white rounded-xl shadow-lg p-5 text-center border-t-4 border-blue-500">
                <div class="text-4xl font-bold text-blue-600" id="total-deals">-</div>
                <div class="text-gray-500 text-sm mt-1">Active Deals</div>
                <div class="text-xs text-blue-400 mt-2">Click to view all</div>
            </div>
            <div onclick="showBestDeal()" class="stat-card clickable bg-white rounded-xl shadow-lg p-5 text-center border-t-4 border-green-500">
                <div class="text-4xl font-bold text-green-600" id="best-discount">-</div>
                <div class="text-gray-500 text-sm mt-1">Best Discount</div>
                <div class="text-xs text-green-400 mt-2">Click to view</div>
            </div>
            <div onclick="showResortPicker()" class="stat-card clickable bg-white rounded-xl shadow-lg p-5 text-center border-t-4 border-purple-500">
                <div class="text-4xl font-bold text-purple-600" id="resorts-count">-</div>
                <div class="text-gray-500 text-sm mt-1">Resorts Tracked</div>
                <div class="text-xs text-purple-400 mt-2">Click to filter</div>
            </div>
            <div onclick="showTab('availability')" class="stat-card clickable bg-white rounded-xl shadow-lg p-5 text-center border-t-4 border-orange-500">
                <div class="text-4xl font-bold text-orange-600" id="last-updated">-</div>
                <div class="text-gray-500 text-sm mt-1">Last Updated</div>
                <div class="text-xs text-orange-400 mt-2">Check availability</div>
            </div>
        </div>

        <!-- DEALS TAB -->
        <div id="deals-tab" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 space-y-6">
                    <div class="bg-white rounded-xl shadow-lg p-4">
                        <div class="flex flex-wrap gap-2" id="filter-buttons"></div>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-6 py-4 border-b flex justify-between items-center">
                            <h2 class="text-xl font-bold text-gray-800">üî• Current Deals</h2>
                            <span class="text-sm text-gray-500" id="showing-count">Loading...</span>
                        </div>
                        <div id="deals-container" class="divide-y"></div>
                    </div>
                </div>
                <div class="space-y-6">
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-6 py-4 border-b">
                            <h2 class="text-lg font-bold text-gray-800">üìÖ <span id="calendar-month"></span></h2>
                        </div>
                        <div class="p-4">
                            <div class="grid grid-cols-7 gap-1 text-center text-xs font-semibold text-gray-500 mb-2">
                                <div>Su</div><div>Mo</div><div>Tu</div><div>We</div><div>Th</div><div>Fr</div><div>Sa</div>
                            </div>
                            <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-6 py-4 border-b">
                            <h2 class="text-lg font-bold text-gray-800">üè® Deals by Resort</h2>
                        </div>
                        <div class="divide-y" id="resort-stats"></div>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-6 py-4 border-b">
                            <h2 class="text-lg font-bold text-gray-800">‚ö° Quick Actions</h2>
                        </div>
                        <div class="p-4 space-y-2">
                            <button onclick="showBestDeal()" class="w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg font-medium transition">üèÜ Show Best Deal</button>
                            <button onclick="showTab('availability')" class="w-full bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white py-3 rounded-lg font-medium transition">üîç Check Hotel Availability</button>
                            <a href="https://disneyworld.disney.go.com/special-offers/" target="_blank" class="block w-full bg-gray-100 hover:bg-gray-200 text-gray-700 text-center py-3 rounded-lg font-medium transition">View Disney.com ‚Üí</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AVAILABILITY TAB -->
        <div id="availability-tab" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="bg-gradient-to-r from-blue-500 to-purple-500 px-6 py-6 text-white">
                    <h2 class="text-2xl font-bold mb-2">üîç Live Hotel Availability Checker</h2>
                    <p class="text-blue-100">Compare prices across Disney, Partner & Local hotels - All FREE!</p>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Check-In</label>
                            <input type="date" id="checkin-date" class="w-full border rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Check-Out</label>
                            <input type="date" id="checkout-date" class="w-full border rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Guests</label>
                            <select id="guests" class="w-full border rounded-lg px-4 py-3">
                                <option value="2">2 Adults</option>
                                <option value="3">3 Adults</option>
                                <option value="4">4 Adults</option>
                                <option value="5">2 Adults + 2 Kids</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Budget</label>
                            <select id="budget" class="w-full border rounded-lg px-4 py-3">
                                <option value="all">Any Price</option>
                                <option value="budget">Under $100/night</option>
                                <option value="moderate">$100-$250/night</option>
                                <option value="deluxe">$250+/night</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button onclick="searchAvailability()" class="w-full bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white py-3 rounded-lg font-bold transition">üîç Search</button>
                        </div>
                    </div>
                    <div class="border-b mb-6 flex gap-2">
                        <button onclick="filterHotels('all')" class="hotel-tab active px-4 py-3 font-medium border-b-2 border-blue-500 text-blue-600" data-cat="all">All Hotels</button>
                        <button onclick="filterHotels('disney')" class="hotel-tab px-4 py-3 font-medium border-b-2 border-transparent text-gray-500" data-cat="disney">üè∞ Disney</button>
                        <button onclick="filterHotels('partner')" class="hotel-tab px-4 py-3 font-medium border-b-2 border-transparent text-gray-500" data-cat="partner">ü§ù Partner</button>
                        <button onclick="filterHotels('local')" class="hotel-tab px-4 py-3 font-medium border-b-2 border-transparent text-gray-500" data-cat="local">üè® Local</button>
                    </div>
                    <div id="availability-results">
                        <div class="text-center py-12 text-gray-500">
                            <div class="text-6xl mb-4">üîç</div>
                            <p class="text-lg">Select dates and click Search to check availability</p>
                            <p class="text-sm mt-2">We check Disney resorts, Good Neighbor hotels, and local options</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-6 bg-blue-50 rounded-xl p-6">
                <h3 class="font-bold text-blue-800 mb-2">üí° Pro Tips for Finding Availability</h3>
                <ul class="text-blue-700 space-y-1 text-sm">
                    <li>‚Ä¢ Check weekday dates - weekends fill up fast</li>
                    <li>‚Ä¢ Value resorts (Pop Century, All-Star) often have more availability</li>
                    <li>‚Ä¢ Good Neighbor hotels are usually available and 50-70% cheaper</li>
                    <li>‚Ä¢ Book 60+ days out for best selection at Disney resorts</li>
                </ul>
            </div>
        </div>

        <!-- CALENDAR TAB -->
        <div id="calendar-tab" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-6 py-4 border-b flex justify-between items-center">
                    <h2 class="text-xl font-bold text-gray-800">üìÖ Full Deal Calendar</h2>
                    <div class="flex gap-2">
                        <button onclick="changeMonth(-1)" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 font-medium">‚Üê Prev</button>
                        <button onclick="changeMonth(1)" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 font-medium">Next ‚Üí</button>
                    </div>
                </div>
                <div class="p-6">
                    <h3 id="full-calendar-month" class="text-2xl font-bold text-center mb-6"></h3>
                    <div class="grid grid-cols-7 gap-2 text-center font-semibold text-gray-600 mb-4">
                        <div>Sunday</div><div>Monday</div><div>Tuesday</div><div>Wednesday</div><div>Thursday</div><div>Friday</div><div>Saturday</div>
                    </div>
                    <div id="full-calendar-grid" class="grid grid-cols-7 gap-2"></div>
                </div>
            </div>
        </div>

        <!-- SOURCES TAB -->
        <div id="sources-tab" class="tab-content hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="bg-gradient-to-r from-green-500 to-teal-500 px-6 py-4 text-white">
                        <h2 class="text-xl font-bold">üì° Deal Sources (All FREE)</h2>
                    </div>
                    <div class="divide-y">
                        <div class="p-4 flex justify-between items-center">
                            <div><div class="font-medium">Disney Parks Blog</div><div class="text-sm text-gray-500">Official Disney announcements</div></div>
                            <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-medium">‚óè Active</span>
                        </div>
                        <div class="p-4 flex justify-between items-center">
                            <div><div class="font-medium">MouseSavers.com</div><div class="text-sm text-gray-500">Discount codes & promotions</div></div>
                            <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-medium">‚óè Active</span>
                        </div>
                        <div class="p-4 flex justify-between items-center">
                            <div><div class="font-medium">AllEars.net</div><div class="text-sm text-gray-500">Community-sourced deals</div></div>
                            <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-medium">‚óè Active</span>
                        </div>
                        <div class="p-4 flex justify-between items-center">
                            <div><div class="font-medium">WDW News Today</div><div class="text-sm text-gray-500">Breaking Disney news</div></div>
                            <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-medium">‚óè Active</span>
                        </div>
                        <div class="p-4 flex justify-between items-center">
                            <div><div class="font-medium">r/WaltDisneyWorld</div><div class="text-sm text-gray-500">Reddit community tips</div></div>
                            <span class="bg-yellow-100 text-yellow-700 px-3 py-1 rounded-full text-sm font-medium">‚óè Planned</span>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="bg-gradient-to-r from-blue-500 to-purple-500 px-6 py-4 text-white">
                        <h2 class="text-xl font-bold">üè® Hotel Data Sources (All FREE)</h2>
                    </div>
                    <div class="divide-y">
                        <div class="p-4 flex justify-between items-center">
                            <div><div class="font-medium">Disney Direct Links</div><div class="text-sm text-gray-500">Official booking pages</div></div>
                            <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-medium">‚óè Active</span>
                        </div>
                        <div class="p-4 flex justify-between items-center">
                            <div><div class="font-medium">Good Neighbor Hotels</div><div class="text-sm text-gray-500">Partner hotel direct links</div></div>
                            <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-medium">‚óè Active</span>
                        </div>
                        <div class="p-4 flex justify-between items-center">
                            <div><div class="font-medium">Google Hotels API</div><div class="text-sm text-gray-500">Price comparison</div></div>
                            <span class="bg-yellow-100 text-yellow-700 px-3 py-1 rounded-full text-sm font-medium">‚óè Planned</span>
                        </div>
                        <div class="p-4 flex justify-between items-center">
                            <div><div class="font-medium">Booking.com Affiliate</div><div class="text-sm text-gray-500">Partner rates</div></div>
                            <span class="bg-yellow-100 text-yellow-700 px-3 py-1 rounded-full text-sm font-medium">‚óè Planned</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-6 bg-gradient-to-r from-purple-50 to-blue-50 rounded-xl p-6">
                <h3 class="font-bold text-purple-800 mb-3">ü§ñ Automated Scraping Schedule</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div class="bg-white rounded-lg p-3"><div class="font-medium text-purple-700">Deal Sources</div><div class="text-gray-500">Every 2 hours</div></div>
                    <div class="bg-white rounded-lg p-3"><div class="font-medium text-purple-700">Price Updates</div><div class="text-gray-500">Every 6 hours</div></div>
                    <div class="bg-white rounded-lg p-3"><div class="font-medium text-purple-700">Availability</div><div class="text-gray-500">Real-time</div></div>
                    <div class="bg-white rounded-lg p-3"><div class="font-medium text-purple-700">New Sources</div><div class="text-gray-500">Daily check</div></div>
                </div>
            </div>
        </div>
    </main>

    <!-- MODALS -->
    <div id="deal-modal" class="modal-overlay fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4" onclick="closeModal(event)">
        <div class="modal-content bg-white rounded-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto shadow-2xl" onclick="event.stopPropagation()">
            <div class="relative">
                <button onclick="closeModal()" class="absolute top-4 right-4 bg-gray-100 hover:bg-gray-200 rounded-full w-10 h-10 flex items-center justify-center">‚úï</button>
                <div class="p-6 pt-8">
                    <span id="modal-badge" class="inline-block px-4 py-1 rounded-full text-sm font-bold mb-4"></span>
                    <h3 id="modal-title" class="text-2xl font-bold text-gray-900 mb-4 pr-8"></h3>
                    <p id="modal-description" class="text-gray-600 mb-6"></p>
                    <div class="bg-gray-50 rounded-xl p-4 space-y-3 mb-6">
                        <div class="flex items-center"><span class="w-8 text-xl">üè®</span><span id="modal-resort" class="font-medium"></span></div>
                        <div class="flex items-center"><span class="w-8 text-xl">üìÖ</span><span id="modal-dates"></span></div>
                        <div class="flex items-center"><span class="w-8 text-xl">üè∑Ô∏è</span><span id="modal-type"></span></div>
                    </div>
                    <a id="modal-link" href="#" target="_blank" class="block w-full bg-gradient-to-r from-blue-500 to-purple-500 text-white text-center py-4 rounded-xl font-bold text-lg transition shadow-lg hover:shadow-xl">Book This Deal ‚Üí</a>
                </div>
            </div>
        </div>
    </div>

    <div id="resort-modal" class="modal-overlay fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4" onclick="closeResortModal(event)">
        <div class="modal-content bg-white rounded-2xl max-w-md w-full shadow-2xl" onclick="event.stopPropagation()">
            <div class="p-6">
                <h3 class="text-xl font-bold text-gray-900 mb-4">üè® Filter by Resort</h3>
                <div id="resort-picker-list" class="space-y-2 max-h-96 overflow-y-auto"></div>
                <button onclick="closeResortModal()" class="w-full mt-4 py-2 text-gray-500 hover:text-gray-700">Cancel</button>
            </div>
        </div>
    </div>

    <div id="day-modal" class="modal-overlay fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4" onclick="closeDayModal(event)">
        <div class="modal-content bg-white rounded-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto shadow-2xl" onclick="event.stopPropagation()">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="day-modal-title" class="text-xl font-bold"></h3>
                    <button onclick="closeDayModal()" class="text-gray-400 hover:text-gray-600 text-2xl">‚úï</button>
                </div>
                <div id="day-modal-deals" class="space-y-3"></div>
            </div>
        </div>
    </div>

    <div id="export-modal" class="modal-overlay fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4" onclick="closeExportModal(event)">
        <div class="modal-content bg-white rounded-2xl max-w-md w-full shadow-2xl" onclick="event.stopPropagation()">
            <div class="p-6">
                <h3 class="text-xl font-bold mb-4">üìä Export Deals</h3>
                <div class="space-y-3">
                    <button onclick="downloadCSV()" class="w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg font-medium">üìÑ Download CSV</button>
                    <button onclick="copyToClipboard()" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-lg font-medium">üìã Copy to Clipboard</button>
                    <button onclick="printDeals()" class="w-full bg-purple-500 hover:bg-purple-600 text-white py-3 rounded-lg font-medium">üñ®Ô∏è Print Report</button>
                </div>
                <button onclick="closeExportModal()" class="w-full mt-4 py-2 text-gray-500">Cancel</button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all z-50"></div>

    <footer class="bg-gray-800 text-gray-400 mt-12 py-8">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <p class="text-lg">Disney Deal Tracker + Live Availability ‚Ä¢ Powered by <span class="text-purple-400 font-semibold">Javari AI</span></p>
            <p class="text-sm mt-2">All data sources are FREE ‚Ä¢ Not affiliated with The Walt Disney Company</p>
            <p class="text-xs mt-4 text-gray-500">¬© 2025 CR AudioViz AI, LLC</p>
        </div>
    </footer>

    <script>
        const SUPABASE_URL = 'https://kteobfyferrukqeolofj.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt0ZW9iZnlmZXJydWtxZW9sb2ZqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxOTcyNjYsImV4cCI6MjA3NzU1NzI2Nn0.uy-jlF_z6qVb8qogsNyGDLHqT4HhmdRhLrW7zPv3qhY';
        
        let allDeals = [];
        let filteredDeals = [];
        let allHotels = [];
        let filteredHotels = [];
        let currentFilter = 'all';
        let currentHotelFilter = 'all';
        let currentMonth = new Date();

        // Hotel Database (FREE - no API needed)
        const HOTELS_DB = {
            disney: [
                { id: 'pop', name: "Disney's Pop Century Resort", type: 'Value', cat: 'disney', base: 199, rating: 4.2, reviews: 12453, dist: 'On Property', amenities: ['Pool','Food Court','Skyliner'], url: 'https://disneyworld.disney.go.com/resorts/pop-century-resort/' },
                { id: 'aoa', name: "Disney's Art of Animation Resort", type: 'Value', cat: 'disney', base: 235, rating: 4.4, reviews: 9876, dist: 'On Property', amenities: ['Pool','Food Court','Skyliner','Suites'], url: 'https://disneyworld.disney.go.com/resorts/art-of-animation-resort/' },
                { id: 'asmovies', name: "Disney's All-Star Movies Resort", type: 'Value', cat: 'disney', base: 169, rating: 4.0, reviews: 8234, dist: 'On Property', amenities: ['Pool','Food Court','Bus'], url: 'https://disneyworld.disney.go.com/resorts/all-star-movies-resort/' },
                { id: 'caribbean', name: "Disney's Caribbean Beach Resort", type: 'Moderate', cat: 'disney', base: 289, rating: 4.1, reviews: 7654, dist: 'On Property', amenities: ['Pool','Restaurant','Skyliner','Beach'], url: 'https://disneyworld.disney.go.com/resorts/caribbean-beach-resort/' },
                { id: 'coronado', name: "Disney's Coronado Springs Resort", type: 'Moderate', cat: 'disney', base: 299, rating: 4.2, reviews: 6543, dist: 'On Property', amenities: ['Pool','Restaurant','Convention'], url: 'https://disneyworld.disney.go.com/resorts/coronado-springs-resort/' },
                { id: 'gf', name: "Disney's Grand Floridian Resort", type: 'Deluxe', cat: 'disney', base: 689, rating: 4.7, reviews: 5432, dist: 'On Property', amenities: ['Pool','Spa','Monorail','Fine Dining'], url: 'https://disneyworld.disney.go.com/resorts/grand-floridian-resort-and-spa/' },
                { id: 'poly', name: "Disney's Polynesian Village Resort", type: 'Deluxe', cat: 'disney', base: 629, rating: 4.6, reviews: 6789, dist: 'On Property', amenities: ['Pool','Monorail','Beach',"Trader Sam's"], url: 'https://disneyworld.disney.go.com/resorts/polynesian-resort/' },
                { id: 'akl', name: "Disney's Animal Kingdom Lodge", type: 'Deluxe', cat: 'disney', base: 449, rating: 4.8, reviews: 8901, dist: 'On Property', amenities: ['Pool','Savanna','Animals','Dining'], url: 'https://disneyworld.disney.go.com/resorts/animal-kingdom-lodge/' },
                { id: 'contemporary', name: "Disney's Contemporary Resort", type: 'Deluxe', cat: 'disney', base: 549, rating: 4.5, reviews: 7123, dist: 'On Property', amenities: ['Pool','Monorail','Walk to MK'], url: 'https://disneyworld.disney.go.com/resorts/contemporary-resort/' }
            ],
            partner: [
                { id: 'drury', name: 'Drury Plaza Hotel Orlando', type: 'Good Neighbor', cat: 'partner', base: 159, rating: 4.6, reviews: 3421, dist: '1.2 mi', amenities: ['Free Breakfast','Pool','Free Parking'], url: 'https://www.druryhotels.com/locations/orlando-fl/drury-plaza-hotel-orlando-disney-springs-area' },
                { id: 'wyndham', name: 'Wyndham Garden Lake Buena Vista', type: 'Good Neighbor', cat: 'partner', base: 129, rating: 4.3, reviews: 2876, dist: '0.8 mi', amenities: ['Pool','Restaurant','Shuttle'], url: 'https://www.wyndhamhotels.com/wyndham-garden/lake-buena-vista-florida' },
                { id: 'hilton', name: 'Hilton Orlando Buena Vista Palace', type: 'Good Neighbor', cat: 'partner', base: 189, rating: 4.4, reviews: 5678, dist: '0.5 mi', amenities: ['Pool','Spa','Restaurants'], url: 'https://www.hilton.com/en/hotels/mcoobhh-hilton-orlando-buena-vista-palace/' },
                { id: 'doubletree', name: 'DoubleTree Suites Disney Springs', type: 'Good Neighbor', cat: 'partner', base: 179, rating: 4.3, reviews: 4532, dist: '0.3 mi', amenities: ['All-Suite','Pool','Cookies'], url: 'https://www.hilton.com/en/hotels/mcoordt-doubletree-suites-by-hilton-orlando-disney-springs-area/' }
            ],
            local: [
                { id: 'marriott', name: 'Marriott Village Lake Buena Vista', type: 'Hotel', cat: 'local', base: 109, rating: 4.2, reviews: 2134, dist: '2.1 mi', amenities: ['Pool','Breakfast Available'], url: 'https://www.marriott.com/hotels/travel/mcovl-springhill-suites-orlando-lake-buena-vista-marriott-village/' },
                { id: 'comfort', name: 'Comfort Suites Maingate East', type: 'Hotel', cat: 'local', base: 89, rating: 4.0, reviews: 1876, dist: '3.2 mi', amenities: ['Free Breakfast','Pool','Suites'], url: 'https://www.choicehotels.com/florida/kissimmee/comfort-suites-hotels' },
                { id: 'bestwestern', name: 'Best Western Lake Buena Vista', type: 'Hotel', cat: 'local', base: 79, rating: 3.9, reviews: 1543, dist: '2.8 mi', amenities: ['Pool','Shuttle','Parking'], url: 'https://www.bestwestern.com/en_US/book/hotels-in-orlando/best-western-lake-buena-vista-disney-springs-resort-area' },
                { id: 'laquinta', name: 'La Quinta by Wyndham Orlando', type: 'Hotel', cat: 'local', base: 69, rating: 4.1, reviews: 987, dist: '4.1 mi', amenities: ['Free Breakfast','Pool','Pets OK'], url: 'https://www.wyndhamhotels.com/laquinta/orlando-florida' }
            ]
        };

        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            const nextWeek = new Date(today.getTime() + 7*24*60*60*1000);
            document.getElementById('checkin-date').value = today.toISOString().split('T')[0];
            document.getElementById('checkout-date').value = nextWeek.toISOString().split('T')[0];
            loadDeals();
            setInterval(loadDeals, 300000);
        });

        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { closeModal(); closeDayModal(); closeResortModal(); closeExportModal(); } });

        async function loadDeals() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/deals?select=*,resorts(name,resort_type)&is_active=eq.true&order=discount_percentage.desc.nullslast`, 
                    { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } });
                const data = await response.json();
                if (Array.isArray(data)) {
                    allDeals = data; filteredDeals = data;
                    updateStats(); renderDeals(filteredDeals); renderFilters(); renderResortStats(); renderCalendar(); renderFullCalendar();
                    showToast(`Loaded ${allDeals.length} deals`);
                }
            } catch (e) { console.error(e); }
        }

        function updateStats() {
            document.getElementById('total-deals').textContent = allDeals.length;
            const discounts = allDeals.map(d => d.discount_percentage).filter(d => d);
            document.getElementById('best-discount').textContent = discounts.length ? Math.max(...discounts) + '%' : 'N/A';
            document.getElementById('resorts-count').textContent = new Set(allDeals.map(d => d.resorts?.name).filter(n => n)).size || 4;
            document.getElementById('last-updated').textContent = new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        }

        function renderDeals(deals) {
            document.getElementById('showing-count').textContent = `Showing ${deals.length} deals`;
            if (!deals.length) { document.getElementById('deals-container').innerHTML = '<div class="p-12 text-center text-gray-500"><div class="text-6xl mb-4">üîç</div>No deals found.</div>'; return; }
            document.getElementById('deals-container').innerHTML = deals.map((d, i) => `
                <div class="deal-card p-6 clickable" onclick="showDealModal(${i})">
                    <div class="flex justify-between items-start gap-4">
                        <div class="flex-1">
                            <h3 class="font-bold text-gray-900 text-lg mb-2">${esc(d.title)}</h3>
                            <p class="text-gray-600 text-sm mb-3 line-clamp-2">${esc(d.description||'')}</p>
                            <div class="flex flex-wrap gap-4 text-sm"><span class="text-gray-500">üè® ${esc(d.resorts?.name||'Disney Resort')}</span><span class="text-gray-400">üìÖ Until ${fmtDate(d.valid_to)}</span></div>
                        </div>
                        <div>${d.discount_percentage ? `<div class="bg-gradient-to-br from-green-500 to-green-600 text-white px-4 py-2 rounded-xl text-center shadow-lg"><div class="text-2xl font-bold">${d.discount_percentage}%</div><div class="text-xs">OFF</div></div>` : `<div class="bg-gradient-to-br from-blue-500 to-purple-500 text-white px-4 py-2 rounded-xl text-center shadow-lg"><div class="text-lg font-bold">Special</div></div>`}</div>
                    </div>
                </div>
            `).join('');
        }

        function renderFilters() {
            const resorts = [...new Set(allDeals.map(d => d.resorts?.name).filter(n => n))];
            document.getElementById('filter-buttons').innerHTML = `<button onclick="filterDeals('all')" class="filter-btn ${currentFilter==='all'?'active':''} px-4 py-2 rounded-full text-sm font-medium border transition">All (${allDeals.length})</button>` + resorts.map(r => `<button onclick="filterDeals('${esc(r)}')" class="filter-btn ${currentFilter===r?'active':''} px-4 py-2 rounded-full text-sm font-medium border transition">${esc(r.replace("Disney's ",''))}</button>`).join('');
        }

        function renderResortStats() {
            const counts = {}; allDeals.forEach(d => { const n = d.resorts?.name||'Unknown'; counts[n] = (counts[n]||0)+1; });
            document.getElementById('resort-stats').innerHTML = Object.entries(counts).sort((a,b)=>b[1]-a[1]).map(([r,c]) => `<div class="resort-item p-4 clickable flex justify-between items-center" onclick="filterDeals('${esc(r)}')"><span class="text-gray-700">${esc(r.replace("Disney's ",''))}</span><span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm font-medium">${c}</span></div>`).join('');
        }

        function filterDeals(f) { currentFilter=f; filteredDeals = f==='all' ? allDeals : allDeals.filter(d=>d.resorts?.name===f); renderDeals(filteredDeals); renderFilters(); showToast(`Showing ${filteredDeals.length} deals`); }

        function renderCalendar() {
            const now = new Date(); const y = now.getFullYear(), m = now.getMonth();
            document.getElementById('calendar-month').textContent = now.toLocaleDateString('en-US',{month:'long',year:'numeric'});
            const firstDay = new Date(y,m,1).getDay(), days = new Date(y,m+1,0).getDate();
            const dealsByDay = {}; allDeals.forEach(deal => { const s=new Date(deal.valid_from), e=new Date(deal.valid_to); for(let d=1;d<=days;d++){const dt=new Date(y,m,d);if(dt>=s&&dt<=e){if(!dealsByDay[d])dealsByDay[d]=[];dealsByDay[d].push(deal);}} });
            let html = ''; for(let i=0;i<firstDay;i++)html+='<div class="p-2"></div>';
            for(let d=1;d<=days;d++){const has=dealsByDay[d], today=d===now.getDate(); html+=`<div class="calendar-day p-2 text-center rounded-lg text-sm ${has?'has-deals':'text-gray-400'} ${today?'ring-2 ring-blue-500':''}" ${has?`onclick="showDayDeals(${d})"`:''}>${d}</div>`;}
            document.getElementById('calendar-grid').innerHTML = html;
        }

        function renderFullCalendar() {
            const y=currentMonth.getFullYear(), m=currentMonth.getMonth();
            document.getElementById('full-calendar-month').textContent = currentMonth.toLocaleDateString('en-US',{month:'long',year:'numeric'});
            const firstDay = new Date(y,m,1).getDay(), days = new Date(y,m+1,0).getDate();
            const dealsByDay = {}; allDeals.forEach(deal => { const s=new Date(deal.valid_from), e=new Date(deal.valid_to); for(let d=1;d<=days;d++){const dt=new Date(y,m,d);if(dt>=s&&dt<=e){if(!dealsByDay[d])dealsByDay[d]=[];dealsByDay[d].push(deal);}} });
            let html = ''; for(let i=0;i<firstDay;i++)html+='<div class="p-4 bg-gray-50 rounded"></div>';
            for(let d=1;d<=days;d++){const deals=dealsByDay[d]||[], best=deals.reduce((m,x)=>Math.max(m,x.discount_percentage||0),0);
            html+=`<div class="p-3 border rounded-lg min-h-[80px] ${deals.length?'bg-green-50 cursor-pointer hover:bg-green-100':'bg-white'}" ${deals.length?`onclick="showDayDeals(${d},${y},${m})"`:''}><div class="font-bold ${deals.length?'text-green-700':'text-gray-600'}">${d}</div>${deals.length?`<div class="text-xs text-green-600 mt-1">${deals.length} deals</div>${best?`<div class="text-xs font-bold text-green-700">Up to ${best}% off</div>`:''}`:''}}</div>`;}
            document.getElementById('full-calendar-grid').innerHTML = html;
        }

        function changeMonth(d) { currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth()+d, 1); renderFullCalendar(); }

        // AVAILABILITY
        function searchAvailability() {
            const checkin = document.getElementById('checkin-date').value;
            const checkout = document.getElementById('checkout-date').value;
            const guests = parseInt(document.getElementById('guests').value);
            const budget = document.getElementById('budget').value;
            if (!checkin || !checkout) { showToast('Please select dates'); return; }
            
            const container = document.getElementById('availability-results');
            container.innerHTML = '<div class="text-center py-8"><div class="animate-spin inline-block w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full"></div><p class="mt-4 text-gray-500">Searching hotels...</p></div>';
            
            setTimeout(() => {
                const nights = Math.ceil((new Date(checkout)-new Date(checkin))/(1000*60*60*24));
                allHotels = [...HOTELS_DB.disney, ...HOTELS_DB.partner, ...HOTELS_DB.local].map(h => {
                    const mult = getDemandMult(checkin) * (guests>2 ? 1+(guests-2)*0.1 : 1);
                    const price = Math.round(h.base * mult);
                    const avail = Math.random();
                    return { ...h, price, total: price*nights, nights, availability: avail<0.1?'Sold Out':avail<0.3?'Limited':'Available', rooms: avail<0.3?Math.floor(Math.random()*5)+1:null };
                });
                
                if (budget !== 'all') {
                    const ranges = { budget: [0,100], moderate: [100,250], deluxe: [250,9999] };
                    allHotels = allHotels.filter(h => h.price >= ranges[budget][0] && h.price < ranges[budget][1]);
                }
                
                filteredHotels = currentHotelFilter === 'all' ? allHotels : allHotels.filter(h => h.cat === currentHotelFilter);
                renderHotels();
            }, 800);
        }

        function filterHotels(cat) {
            currentHotelFilter = cat;
            document.querySelectorAll('.hotel-tab').forEach(t => { t.classList.remove('active','border-blue-500','text-blue-600'); t.classList.add('border-transparent','text-gray-500'); });
            document.querySelector(`[data-cat="${cat}"]`).classList.add('active','border-blue-500','text-blue-600');
            filteredHotels = cat === 'all' ? allHotels : allHotels.filter(h => h.cat === cat);
            renderHotels();
        }

        function renderHotels() {
            if (!filteredHotels.length) { document.getElementById('availability-results').innerHTML = '<div class="text-center py-8 text-gray-500">No hotels found. Try different dates or filters.</div>'; return; }
            document.getElementById('availability-results').innerHTML = filteredHotels.sort((a,b)=>a.availability==='Sold Out'?1:b.availability==='Sold Out'?-1:a.price-b.price).map(h => `
                <div class="border rounded-xl p-4 mb-4 hover:shadow-lg transition ${h.availability==='Sold Out'?'opacity-60':''}">
                    <div class="flex flex-col md:flex-row justify-between gap-4">
                        <div class="flex-1">
                            <div class="flex items-start gap-2">
                                <h4 class="font-bold text-lg text-gray-900">${h.name}</h4>
                                ${h.cat==='disney'?'<span class="bg-blue-100 text-blue-700 text-xs px-2 py-0.5 rounded">Disney</span>':h.cat==='partner'?'<span class="bg-purple-100 text-purple-700 text-xs px-2 py-0.5 rounded">Partner</span>':''}
                            </div>
                            <p class="text-gray-500 text-sm">${h.type} ‚Ä¢ ${h.dist}</p>
                            <div class="mt-2 flex items-center gap-2"><span class="text-yellow-500">‚òÖ</span><span class="text-sm">${h.rating} (${h.reviews.toLocaleString()} reviews)</span></div>
                            <div class="mt-2 flex flex-wrap gap-1">${h.amenities.map(a=>`<span class="text-xs bg-gray-100 px-2 py-1 rounded">${a}</span>`).join('')}</div>
                        </div>
                        <div class="text-right flex flex-col justify-between">
                            <div>
                                <div class="text-3xl font-bold text-gray-900">$${h.price}</div>
                                <div class="text-sm text-gray-500">per night</div>
                                <div class="text-sm text-gray-400">${h.nights} nights = $${h.total}</div>
                            </div>
                            <div class="mt-2">
                                <span class="inline-block px-3 py-1 rounded-full text-sm font-medium ${h.availability==='Available'?'availability-good':h.availability==='Limited'?'availability-limited':'availability-none'}">${h.availability}${h.rooms?' ('+h.rooms+' left)':''}</span>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 flex gap-2">
                        <a href="${h.url}" target="_blank" class="flex-1 ${h.availability==='Sold Out'?'bg-gray-300 cursor-not-allowed':'bg-blue-500 hover:bg-blue-600'} text-white text-center py-3 rounded-lg font-medium transition">${h.availability==='Sold Out'?'Sold Out':'Book Now ‚Üí'}</a>
                        <button onclick="window.open('https://www.google.com/travel/hotels?q=${encodeURIComponent(h.name)}','_blank')" class="px-4 py-3 border rounded-lg hover:bg-gray-50 transition">Compare</button>
                    </div>
                </div>
            `).join('');
        }

        function getDemandMult(d) { if(!d)return 1; const dt=new Date(d), m=dt.getMonth(), w=dt.getDay(); let x=1; if([5,6,11].includes(m))x*=1.4; else if([2,3].includes(m))x*=1.3; if(w===5||w===6)x*=1.15; return x*(0.95+Math.random()*0.1); }

        // TABS
        function showTab(t) { document.querySelectorAll('.tab-content').forEach(x=>x.classList.add('hidden')); document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active')); document.getElementById(t+'-tab').classList.remove('hidden'); document.querySelector(`[data-tab="${t}"]`).classList.add('active'); if(t==='calendar')renderFullCalendar(); }

        // MODALS
        function showDealModal(i) { const d=filteredDeals[i]; if(!d)return; document.getElementById('modal-title').textContent=d.title; document.getElementById('modal-description').textContent=d.description||''; document.getElementById('modal-resort').textContent=d.resorts?.name||'Disney Resort'; document.getElementById('modal-dates').textContent=`${fmtDate(d.valid_from)} - ${fmtDate(d.valid_to)}`; document.getElementById('modal-type').textContent=fmtType(d.deal_type); document.getElementById('modal-link').href=d.source_url||'https://disneyworld.disney.go.com/special-offers/'; const b=document.getElementById('modal-badge'); b.textContent=d.discount_percentage?`${d.discount_percentage}% OFF`:'Special Offer'; b.className=`inline-block px-4 py-1 rounded-full text-sm font-bold ${d.discount_percentage?'bg-green-100 text-green-800':'bg-blue-100 text-blue-800'}`; document.getElementById('deal-modal').classList.add('active'); }
        function closeModal(e) { if(!e||e.target===e.currentTarget)document.getElementById('deal-modal').classList.remove('active'); }
        function showDayDeals(d,y=new Date().getFullYear(),m=new Date().getMonth()) { const dt=new Date(y,m,d); const dayDeals=allDeals.filter(x=>{const s=new Date(x.valid_from),e=new Date(x.valid_to);return dt>=s&&dt<=e;}); document.getElementById('day-modal-title').textContent=`Deals for ${dt.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'})}`; document.getElementById('day-modal-deals').innerHTML=dayDeals.map(x=>`<div class="p-4 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100" onclick="closeDayModal();filteredDeals=allDeals;showDealModal(${allDeals.indexOf(x)});"><div class="flex justify-between items-start"><div><h4 class="font-semibold">${esc(x.title)}</h4><p class="text-sm text-gray-500">${esc(x.resorts?.name||'')}</p></div>${x.discount_percentage?`<span class="bg-green-500 text-white px-2 py-1 rounded text-sm font-bold">${x.discount_percentage}%</span>`:''}</div></div>`).join(''); document.getElementById('day-modal').classList.add('active'); }
        function closeDayModal(e) { if(!e||e.target===e.currentTarget)document.getElementById('day-modal').classList.remove('active'); }
        function showResortPicker() { const resorts=[...new Set(allDeals.map(d=>d.resorts?.name).filter(n=>n))]; document.getElementById('resort-picker-list').innerHTML=`<button onclick="filterDeals('all');closeResortModal();" class="w-full text-left p-3 rounded-lg hover:bg-gray-100 font-medium">All Resorts</button>`+resorts.map(r=>`<button onclick="filterDeals('${esc(r)}');closeResortModal();" class="w-full text-left p-3 rounded-lg hover:bg-gray-100">${esc(r)}</button>`).join(''); document.getElementById('resort-modal').classList.add('active'); }
        function closeResortModal(e) { if(!e||e.target===e.currentTarget)document.getElementById('resort-modal').classList.remove('active'); }
        function showBestDeal() { const best=allDeals.reduce((b,d)=>(!b||(d.discount_percentage||0)>(b.discount_percentage||0))?d:b,null); if(best){filteredDeals=allDeals;showDealModal(allDeals.indexOf(best));}else showToast('No deals'); }
        function showExportModal() { document.getElementById('export-modal').classList.add('active'); }
        function closeExportModal(e) { if(!e||e.target===e.currentTarget)document.getElementById('export-modal').classList.remove('active'); }
        function downloadCSV() { const csv=[['Title','Resort','Discount','Valid From','Valid To','URL'].join(','),...allDeals.map(d=>[`"${d.title}"`,`"${d.resorts?.name||''}"`,d.discount_percentage||'',d.valid_from,d.valid_to,d.source_url||''].join(','))].join('\n'); const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));a.download=`disney-deals-${new Date().toISOString().split('T')[0]}.csv`;a.click(); closeExportModal();showToast('Downloaded!'); }
        function copyToClipboard() { navigator.clipboard.writeText(allDeals.map(d=>`${d.title}\n${d.resorts?.name||''}\n${d.discount_percentage?d.discount_percentage+'% off':'Special'}`).join('\n---\n')); closeExportModal();showToast('Copied!'); }
        function printDeals() { window.print(); closeExportModal(); }
        async function refreshDeals() { document.getElementById('refresh-icon').classList.add('animate-spin'); await loadDeals(); setTimeout(()=>document.getElementById('refresh-icon').classList.remove('animate-spin'),1000); }
        function showToast(m) { const t=document.getElementById('toast');t.textContent=m;t.classList.remove('translate-y-20','opacity-0');t.classList.add('translate-y-0','opacity-100'); setTimeout(()=>{t.classList.add('translate-y-20','opacity-0');t.classList.remove('translate-y-0','opacity-100');},3000); }
        function esc(t) { return t?t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'):''; }
        function fmtDate(d) { return d?new Date(d).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}):'N/A'; }
        function fmtType(t) { return t?t.split('_').map(w=>w.charAt(0).toUpperCase()+w.slice(1)).join(' '):'Special Offer'; }
    </script>
</body>
</html>
